#define BLYNK_PRINT Serial
#define BLYNK_TEMPLATE_ID "TMPL6FMJN0670" 
#define BLYNK_TEMPLATE_NAME "ProjectWatering"  
#define BLYNK_AUTH_TOKEN "ivkEjPkJ-i3I_4Tz6AIQCsaWn9tq7MaM" 

#include <WiFi.h>
#include <WiFiClientSecure.h> 
#include <BlynkSimpleEsp32.h>
#include <UniversalTelegramBot.h>
#include <ArduinoJson.h>

// --- WiFi & Telegram Config ---
char ssid[] = "‡∏û‡∏°‡πà‡∏≤‡∏á‡∏á";     
char pass[] = "1234567890"; 
#define BOTtoken "8212748170:AAGEL4GdOW39K0gWiJ5x3EkRQ6T-Cv5S0io" 
#define CHAT_ID "8239043655" 

// --- Pin Config ---
#define SENSOR_PIN 34      
#define RELAY_PIN 27      

// --- Thresholds (‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå) ---
const int WET_THRESHOLD = 2000; // ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤ "‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å" (‡∏Ñ‡πà‡∏≤‡∏¢‡∏¥‡πà‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏¢‡∏¥‡πà‡∏á‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å)
const int DRY_THRESHOLD = 3000; // ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤ "‡πÅ‡∏´‡πâ‡∏á" (‡∏Ñ‡πà‡∏≤‡∏¢‡∏¥‡πà‡∏á‡∏°‡∏≤‡∏Å‡∏¢‡∏¥‡πà‡∏á‡πÅ‡∏´‡πâ‡∏á) <-- ADDED

// --- Global Objects & Variables ---
WiFiClientSecure clientSecure;
UniversalTelegramBot bot(BOTtoken, clientSecure);
BlynkTimer timer;

bool isWatering = false; // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
bool isAutoMode = false; // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÇ‡∏´‡∏°‡∏î Auto (true) ‡∏´‡∏£‡∏∑‡∏≠ Manual (false) <-- ADDED


void setup() {
  Serial.begin(115200);
  
  pinMode(RELAY_PIN, OUTPUT);
  digitalWrite(RELAY_PIN, LOW); // ‡∏™‡∏±‡πà‡∏á‡∏õ‡∏¥‡∏î‡∏õ‡∏±‡πä‡∏°‡∏ô‡πâ‡∏≥‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°
  
  Blynk.begin(BLYNK_AUTH_TOKEN, ssid, pass); 
  clientSecure.setCACert(TELEGRAM_CERTIFICATE_ROOT); 
  
  // <-- MODIFIED (Added emoji + default mode)
  bot.sendMessage(CHAT_ID, "‚úÖü§ñ ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏î‡∏ô‡πâ‡∏≥: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡πÇ‡∏´‡∏°‡∏î Manual)", "");
  
  // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
  timer.setInterval(1000L, checkWateringStatus); // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏î‡∏ô‡πâ‡∏≥ (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏î‡∏¥‡∏ô‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å)
  timer.setInterval(5000L, updateGauge);        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏Å‡∏à‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô
  timer.setInterval(30000L, checkAutoWatering);  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏î‡∏¥‡∏ô‡πÅ‡∏´‡πâ‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î Auto) <-- ADDED
}

void loop() {
  Blynk.run();
  timer.run();
}

// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏Å‡∏à V0 ---
void updateGauge() {
  int moistureValue = analogRead(SENSOR_PIN);
  Blynk.virtualWrite(V0, moistureValue); 
}

// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏î‡∏ô‡πâ‡∏≥ (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏î‡∏¥‡∏ô‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å) ---
void checkWateringStatus() {
  if (isWatering) {
    int moistureValue = analogRead(SENSOR_PIN);
    Blynk.virtualWrite(V0, moistureValue); 
    
    Serial.print("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏î‡∏ô‡πâ‡∏≥... ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô: ");
    Serial.println(moistureValue);

    // ‡∏ñ‡πâ‡∏≤‡∏î‡∏¥‡∏ô‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å‡∏ñ‡∏∂‡∏á‡πÄ‡∏Å‡∏ì‡∏ë‡πå
    if (moistureValue <= WET_THRESHOLD) {
      Serial.println("‡∏î‡∏¥‡∏ô‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å‡πÅ‡∏•‡πâ‡∏ß! ‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏î‡∏ô‡πâ‡∏≥ (Auto-Stop)");
      digitalWrite(RELAY_PIN, LOW); 
      isWatering = false; 
      
      // <-- MODIFIED (Added emoji)
      bot.sendMessage(CHAT_ID, "üå±üòä ‡∏£‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡∏î‡∏¥‡∏ô‡∏ä‡∏∑‡πâ‡∏ô‡∏û‡∏≠‡∏î‡∏µ", "");
      
      Blynk.virtualWrite(V1, 0); // ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏° V1 ‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô OFF
    }
  }
}

// --- (ADDED) ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î Auto (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏î‡∏¥‡∏ô‡πÅ‡∏´‡πâ‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà) ---
void checkAutoWatering() {
  // ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠: 1. ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î Auto ‡πÅ‡∏•‡∏∞ 2. ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏≠‡∏¢‡∏π‡πà
  if (!isAutoMode || isWatering) {
    return;
  }

  int moistureValue = analogRead(SENSOR_PIN);
  Blynk.virtualWrite(V0, moistureValue); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏Å‡∏à‡∏î‡πâ‡∏ß‡∏¢

  // ‡∏ñ‡πâ‡∏≤‡∏î‡∏¥‡∏ô‡πÅ‡∏´‡πâ‡∏á‡∏ñ‡∏∂‡∏á‡πÄ‡∏Å‡∏ì‡∏ë‡πå
  if (moistureValue > DRY_THRESHOLD) {
    Serial.println("‡∏î‡∏¥‡∏ô‡πÅ‡∏´‡πâ‡∏á! ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥");
    
    // <-- MODIFIED (Added emoji)
    bot.sendMessage(CHAT_ID, "ü•µ ‡∏î‡∏¥‡∏ô‡πÅ‡∏´‡πâ‡∏á! ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥...", "");
    
    isWatering = true; 
    digitalWrite(RELAY_PIN, HIGH); // ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏±‡πä‡∏°
    Blynk.virtualWrite(V1, 1);     // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏° V1 ‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô ON
  }
}


// --- (MODIFIED) ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏° Manual (V1) ---
BLYNK_WRITE(V1) {
  if (param.asInt() == 1) { 
    // --- ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î "‡πÄ‡∏õ‡∏¥‡∏î" ---
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î Auto ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (isAutoMode) {
      Serial.println("‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° V1 ‡πÅ‡∏ï‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î Auto");
      bot.sendMessage(CHAT_ID, "ü§î ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏î‡∏ô‡πâ‡∏≥ Manual ‡πÑ‡∏î‡πâ (‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î Auto)", "");
      Blynk.virtualWrite(V1, 0); // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô OFF
      return;
    }

    // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
    if (isWatering) {
      return; 
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏î‡∏¥‡∏ô‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    int currentMoisture = analogRead(SENSOR_PIN);
    if (currentMoisture <= WET_THRESHOLD) {
        Serial.println("‡∏î‡∏¥‡∏ô‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏î");
        // <-- MODIFIED (Added emoji)
        bot.sendMessage(CHAT_ID, "ü§î ‡∏î‡∏¥‡∏ô‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (Manual)", "");
        Blynk.virtualWrite(V1, 0); 
        return;
    }

    // ‡∏ñ‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç = ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏î‡∏ô‡πâ‡∏≥
    Serial.println("‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏£‡∏î‡∏ô‡πâ‡∏≥!");
    // <-- MODIFIED (Added emoji)
    bot.sendMessage(CHAT_ID, "üíßüèÉ‚Äç‚ôÇÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á (Manual)...", "");
    isWatering = true; 
    digitalWrite(RELAY_PIN, HIGH); 
    
  } else {
    // --- ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î "‡∏õ‡∏¥‡∏î" (‡∏™‡∏±‡πà‡∏á‡∏´‡∏¢‡∏∏‡∏î Manual) ---
    if (isWatering) {
      Serial.println("‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á!");
      digitalWrite(RELAY_PIN, LOW); 
      isWatering = false; 
      // <-- MODIFIED (Added emoji)
      bot.sendMessage(CHAT_ID, "üõë ‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á Manual", "");
    }
  }
}
BLYNK_WRITE(V2) {
  isAutoMode = param.asInt() == 1; // 1 = Auto, 0 = Manual

  if (isAutoMode) {
    Serial.println("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥");
    bot.sendMessage(CHAT_ID, "‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ü§ñ (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏£‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏î‡∏¥‡∏ô‡πÅ‡∏´‡πâ‡∏á)", "");
  } else {
    Serial.println("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î Manual");
    bot.sendMessage(CHAT_ID, "‡πÇ‡∏´‡∏°‡∏î Manual: ‡∏£‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á üôã‚Äç‚ôÇÔ∏è (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏î‡∏ô‡πâ‡∏≥)", "");
  }
}